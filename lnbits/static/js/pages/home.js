window.PageHome = {
  template: '#page-home',
  mixins: [window.windowMixin],
  data() {
    return {
      lnurl: '',
      isUserAuthorized: false,
      authAction: 'login',
      authMethod: 'username-password',
      usr: '',
      username: '',
      reset_key: '',
      email: '',
      password: '',
      passwordRepeat: '',
      walletName: '',
      signup: false
    }
  },
  computed: {
    showClaimLnurl() {
      return (
        this.lnurl !== '' &&
        this.allowRegister &&
        'user-id-only' in this.LNBITS_AUTH_METHODS
      )
    },
    formatDescription() {
      return LNbits.utils.convertMarkdown(this.SITE_DESCRIPTION)
    },
    isAccessTokenExpired() {
      return this.$q.cookies.get('is_access_token_expired')
    },
    allowRegister() {
      return this.LNBITS_NEW_ACCOUNTS_ALLOWED
    },
    // TODO: this makes no sense
    hasCustomImage() {
      return this.LNBITS_CUSTOM_IMAGE
    },
    showHomepageElements() {
      return this.HOMEPAGE_ELEMENTS_ENABLED
    },
    siteTitle() {
      return this.SITE_TITLE || ''
    },
    siteTagline() {
      return this.SITE_TAGLINE || ''
    },
    adsEnabled() {
      return this.AD_SPACE_ENABLED && this.AD_SPACE && this.AD_SPACE.length > 0
    },
    adsTitle() {
      return this.AD_SPACE_TITLE || ''
    },
    ads() {
      return this.AD_SPACE.map(ad => ad.split(';'))
    },
    lnbitsBannerEnabled() {
      return (
        this.LNBITS_DENOMINATION == 'sats' &&
        this.SITE_TITLE == 'LNbits' &&
        this.LNBITS_SHOW_HOME_PAGE_ELEMENTS == true
      )
    }
  },
  methods: {
    showLogin(authMethod) {
      this.authAction = 'login'
      this.authMethod = authMethod
    },
    showRegister(authMethod) {
      this.user = ''
      this.username = null
      this.password = null
      this.passwordRepeat = null

      this.authAction = 'register'
      this.authMethod = authMethod
    },

    async register() {
      try {
        await LNbits.api.register(
          this.username,
          this.email,
          this.password,
          this.passwordRepeat
        )
        window.location.href = '/wallet'
      } catch (e) {
        LNbits.utils.notifyApiError(e)
      }
    },
    async reset() {
      try {
        await LNbits.api.reset(
          this.reset_key,
          this.password,
          this.passwordRepeat
        )
        window.location.href = '/wallet'
      } catch (e) {
        LNbits.utils.notifyApiError(e)
      }
    },
    async login() {
      try {
        await LNbits.api.login(this.username, this.password)
        window.location.href = '/wallet'
      } catch (e) {
        LNbits.utils.notifyApiError(e)
      }
    },
    async loginUsr() {
      try {
        await LNbits.api.loginUsr(this.usr)
        this.usr = ''
        window.location.href = '/wallet'
      } catch (e) {
        console.warn(e)
        LNbits.utils.notifyApiError(e)
      }
    },
    createWallet() {
      LNbits.api.createAccount(this.walletName).then(res => {
        window.location = '/wallet?usr=' + res.data.user + '&wal=' + res.data.id
      })
    },
    processing() {
      Quasar.Notify.create({
        timeout: 0,
        message: 'Processing...',
        icon: null
      })
    }
  },
  created() {
    this.isUserAuthorized = !!this.$q.cookies.get('is_lnbits_user_authorized')

    const _access_cookies_for_safari_refresh_do_not_delete = document.cookie

    if (this.isUserAuthorized) {
      window.location.href = '/wallet'
    }

    const urlParams = new URLSearchParams(window.location.search)

    this.reset_key = urlParams.get('reset_key')
    if (this.reset_key) {
      this.authAction = 'reset'
    }

    // check if lightning parameters are present in the URL
    if (urlParams.has('lightning')) {
      this.lnurl = urlParams.get('lightning')
    }
  }
}
